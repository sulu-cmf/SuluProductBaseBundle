define(["suluproduct/collections/currencies","suluproduct/models/variant","suluproduct/util/header"],function(a,b,c){"use strict";var d={datagridInstanceName:"variants",toolbarInstanceName:"variants"},e={listToolbar:"#js-list-toolbar"},f=function(){var a=new b({locale:this.options.locale,productId:this.options.data.id,flat:!0});return a.url()},g=function(){this.sandbox.sulu.initListToolbarAndList.call(this,"product-variants-list","/admin/api/product-variants/fields",{el:e.listToolbar,instanceName:d.toolbarInstanceName,small:!1,template:this.sandbox.sulu.buttons.get({add:{options:{id:"add",icon:"plus-circle",callback:t.bind(this)}},"delete":{options:{id:"delete",icon:"trash-o",disabled:!0,callback:m.bind(this)}}})},{el:"#product-variants",actionCallback:p.bind(this),instanceName:d.datagridInstanceName,resultKey:"products",searchFields:["name"],url:f.call(this)})},h=function(){this.options.data.attributes.status=c.getSelectedStatus(),this.sandbox.emit("sulu.products.save",this.options.data.attributes,!0)},i=function(){this.sandbox.on("sulu.toolbar.save",h.bind(this)),this.sandbox.on("sulu.products.saved",c.setSaveButton.bind(this,!1)),this.sandbox.on("husky.datagrid."+d.datagridInstanceName+".number.selections",j.bind(this,d.toolbarInstanceName)),this.sandbox.on("sulu.product-variant-overlay.closed",k.bind(this))},j=function(a,b){var c=b>0?"enable":"disable";this.sandbox.emit("husky.toolbar."+a+".item."+c,"delete",!1)},k=function(){this.sandbox.stop(this.$overlay)},l=function(){this.sandbox.dom.html(this.$el,this.renderTemplate("/admin/product/template/product/variants")),g.call(this),0===this.options.data.attributes.variantAttributes.length&&($(e.listToolbar).hide(),this.sandbox.emit("sulu.labels.warning.show","sulu_product.labels.no-variant-attributes-warning","labels.warning"))},m=function(){var a=[],c=null,e=null;this.sandbox.emit("husky.datagrid."+d.datagridInstanceName+".items.get-selected",function(b){a=b}),c=a.length,1>c||(e=new b({productId:this.options.data.id,ids:a}),e.destroy({success:n.bind(this,c),error:o.bind(this)}))},n=function(a){this.options.data.attributes.numberOfVariants-=a,s.call(this),this.sandbox.emit("sulu.labels.success.show","labels.success.delete-desc","labels.success"),this.sandbox.emit("husky.datagrid."+d.datagridInstanceName+".selected.update")},o=function(){this.sandbox.emit("sulu.labels.error.show","sulu_product.labels.delete-error","labels.error")},p=function(a,b){t.call(this,b)},q=function(){var b=$.Deferred(),c=new a({locale:this.options.locale});return c.fetch({success:function(a){b.resolve(a.toJSON())}.bind(this),error:function(){console.error("Error while loading currencies"),b.reject()}}),b.promise()},r=function(a,c){var d=b.findOrCreate({id:a.id,productId:this.options.data.id,locale:c}),e=!!a.id;d.save(a,{success:function(){e||this.options.data.attributes.numberOfVariants++,s.call(this),this.sandbox.emit("sulu.labels.success.show","labels.success.save-desc","labels.success")}.bind(this),error:function(){this.sandbox.emit("sulu.labels.error.show","sulu_product.labels.save-error","labels.error")}.bind(this)})},s=function(){this.sandbox.emit("husky.datagrid."+d.datagridInstanceName+".update")},t=function(a){this.currenciesLoaded.then(function(b){this.$overlay=this.sandbox.dom.createElement("<div>"),this.sandbox.dom.append(this.$el,this.$overlay),this.sandbox.start([{name:"variant-overlay@suluproduct",options:{el:this.$overlay,data:a,currencies:b,locale:this.options.locale,parentPrices:this.options.data.attributes.prices,parentName:this.options.data.attributes.name,variantAttributes:this.options.data.attributes.variantAttributes,okCallback:r.bind(this)}}])}.bind(this))};return{view:!0,templates:["/admin/product/template/product/variants"],initialize:function(){this.$overlay=null,this.currencies=[],this.currenciesLoaded=q.call(this),this.sandbox.emit("product.state.change",this.options.data.attributes.status),l.call(this),i.call(this)}}});