define(["config","text!suluproduct/components/products/components/attributes/overlay-content.html","services/product-type-manager"],function(a,b,c){"use strict";var d="product-attribute-list-toolbar",e="product-attribute-datagrid",f="product-attribute-overlay",g="product-attribute-select",h="product.attribute.type.text",i=null,j={ADD:1,DELETE:2,UPDATE:3},k={variantAttributesContainer:"#js-variant-attributes-container"},l=function(){this.sandbox.on("sulu.toolbar.delete",m.bind(this)),this.sandbox.on("product.state.change",q.bind(this)),this.sandbox.on("sulu.toolbar.save",p.bind(this)),this.sandbox.on("sulu.products.saved",o.bind(this)),this.sandbox.on("husky.datagrid."+e+".number.selections",n.bind(this,d))},m=function(){this.sandbox.emit("sulu.product.delete",this.options.data.id)},n=function(a,b){var c=a>0?"enable":"disable";this.sandbox.emit("husky.toolbar."+b+".item."+c,"delete",!1)},o=function(a){var b=a.attributes;if(a.action===j.ADD){var c=_.findWhere(b,{attributeId:a.attributeIdAdded});this.sandbox.emit("husky.datagrid."+e+".record.add",c)}else a.action===j.DELETE?$.each(a.attributeIdsDeleted,function(a,b){this.sandbox.emit("husky.datagrid."+e+".record.remove",b)}.bind(this)):a.action===j.UPDATE&&this.sandbox.emit("husky.datagrid."+e+".records.set",b);r.call(this,!0),this.options.data.attributes.status=this.status},p=function(){this.sendData={},this.sendData.status=this.status,this.sendData.id=this.options.data.id,u.call(this)},q=function(a){this.options.data&&this.options.data.attributes.status&&this.options.data.attributes.status.id===a.id||(this.status=a,this.options.data.attributes.status=this.status,r.call(this,!1))},r=function(a){a!==this.saved&&(a?this.sandbox.emit("sulu.header.toolbar.item.disable","save",!0):this.sandbox.emit("sulu.header.toolbar.item.enable","save",!1)),this.saved=a},s=function(){i=null;var a=this.sandbox.dom.createElement(this.sandbox.util.template(b,{translate:this.sandbox.translate}));return this.sandbox.dom.append(this.$el,a),a},t=function(){var a="api/attributes?locale="+this.options.locale,b=$.getJSON(a,function(a){this.attributeTypes=[],$.each(a._embedded.attributes,function(a,b){var c={id:b.id,name:b.name};b.type.name===h&&this.attributeTypes.push(c)}.bind(this))}.bind(this));b.done(function(){var a=this.sandbox.dom.createElement("<div>");this.sandbox.dom.append(this.$el,a),this.sandbox.start([{name:"overlay@husky",options:{el:a,supportKeyInput:!1,title:this.sandbox.translate("product.attribute.overlay.title"),skin:"normal",openOnStart:!0,removeOnClose:!0,instanceName:f,data:s.call(this),okCallback:v.bind(this)}}])}.bind(this)),b.fail(function(){console.log("Error retrieving attributes from server")}.bind(this)),b.complete(function(){var a=[];this.attributeTypes.length>0&&"object"==typeof this.attributeTypes[0]&&"string"==typeof this.attributeTypes[0].name&&(i=this.attributeTypes[0].id,a.push(this.attributeTypes[0].name));var b={el:"#selectBox",instanceName:g,multipleSelect:!1,defaultLabel:this.sandbox.translate("product.attribute.overlay.defaultlabel"),preSelectedElements:a,valueName:"name",isNative:!0,data:this.attributeTypes};this.sandbox.start([{name:"select@husky",options:b}]),this.sandbox.on("husky.select."+g+".selected.item",function(a){i=parseInt(a)})}.bind(this))},u=function(){this.saved=!1,this.sandbox.emit("sulu.products.save",this.sendData)},v=function(){if(i){this.sendData={};var a=this.sandbox.dom.val("#attribute-name"),b=this.options.data.attributes.attributes,c=_.findWhere(b,{attributeId:i});if(c)c.attributeValueName=a,c.attributeValueLocale=this.options.locale,this.sendData.action=j.UPDATE;else{var d={attributeId:i,attributeValueName:a,attributeValueLocale:this.options.locale};b.push(d),this.sendData.action=j.ADD}this.sendData.attributeIdAdded=i,this.sendData.attributes=b,this.sendData.status=this.status,this.sendData.id=this.options.data.attributes.id,u.call(this)}},w=function(){this.sandbox.emit("husky.datagrid."+e+".items.get-selected",function(a){var b=this.options.data.attributes.attributes;this.sendData={};var c=[];_.each(a,function(a,d,e){var f=_.findWhere(b,{attributeId:a});b=_.without(b,f),c.push(a)}),this.sendData.attributeIdsDeleted=c,this.sendData.attributes=b,this.sendData.status=this.status,this.sendData.id=this.options.data.id,this.sendData.action=j.DELETE,u.call(this)}.bind(this))},x=function(a,b,c){return a.attributeLocale&&a.attributeLocale==a.fallbackLocale&&a.attributeLocale!=c?(b.title=a.attributeLocale,b):!1},y=function(a,b,c){return a.attributeValueLocale&&a.attributeValueLocale==a.fallbackLocale&&a.attributeValueLocale!=c?(b.title=a.attributeValueLocale,b):!1},z=function(){var a={el:"#product-attribute-list",instanceName:e,idKey:"attributeId",resultKey:"attributes",matchings:[{name:"attributeName",content:this.sandbox.translate("product.attribute.name")},{name:"attributeValueName",content:this.sandbox.translate("product.attribute.value")}],viewOptions:{table:{type:"checkbox",badges:[{column:"attributeName",callback:function(a,b){return x(a,b,this.options.locale)}.bind(this)},{column:"attributeValueName",callback:function(a,b){return y(a,b,this.options.locale)}.bind(this)}]}},data:this.options.data.attributes};this.sandbox.start([{name:"datagrid@husky",options:a}]),this.sandbox.start([{name:"toolbar@husky",options:{el:"#product-attribute-toolbar",instanceName:d,small:!1,buttons:[{id:"add",icon:"plus-circle",callback:t.bind(this)},{id:"delete",icon:"trash-o",disabled:!0,callback:w.bind(this)}]}}])},A=function(){var a={el:"#js-variant-attribute-list",instanceName:e,idKey:"attributeId",resultKey:"attributes",matchings:"/admin/api/product-variant-attributes/fields?locale="+this.options.locale,url:"/admin/api/products/"+this.options.data.id+"/variant-attributes?locale="+this.options.locale};this.sandbox.start([{name:"datagrid@husky",options:a},{name:"toolbar@husky",options:{el:"#js-variant-attribute-toolbar",instanceName:d,small:!1,buttons:[{id:"add",icon:"plus-circle",callback:t.bind(this)},{id:"delete",icon:"trash-o",disabled:!0,callback:w.bind(this)}]}}])},B=function(){var a=this.options.data.attributes.type.id;a===c.types.PRODUCT_WITH_VARIANTS&&($(k.variantAttributesContainer).removeClass("is-hidden"),A.call(this))},C=function(){z.call(this)};return{name:"Sulu Product Attributes View",templates:["/admin/product/template/product/attributes"],initialize:function(){l.call(this),this.status=a.get("product.status.inactive"),this.options.data&&(this.status=this.options.data.attributes.status),this.sandbox.emit("product.state.change",this.status),this.render(),r.call(this,!0)},render:function(){this.sandbox.dom.html(this.$el,this.renderTemplate("/admin/product/template/product/attributes",{translate:this.sandbox.translate})),C.call(this),B.call(this)}}});