define(["config","suluproduct/models/product-addon","text!suluproduct/components/products/components/edit/addons/overlay.html","text!suluproduct/components/products/components/edit/addons/price.html","services/product/product-type-manager"],function(a,b,c,d,e){"use strict";var f=null,g=null,h=null,i={datagridInstanceName:"product-addon-datagrid",toolbarInstanceName:"product-addon-toolbar",overlayInstanceName:"product-addon-overlay",selectInstanceName:"product-addon-select",priceListElementId:"#addon-price-list",loaderElementClass:".loader"},j=function(){var a=[e.types.PRODUCT,e.types.PRODUCT_WITH_VARIANTS,e.types.PRODUCT_ADDON];return"/admin/api/products?flat=true&searchFields=number,name&fields=id,name,number&type="+a.join(",")},k=function(){this.sandbox.on("product.state.change",m.bind(this)),this.sandbox.on("sulu.toolbar.save",v.bind(this)),this.sandbox.on("sulu.products.saved",n.bind(this)),this.sandbox.on("husky.datagrid."+i.datagridInstanceName+".number.selections",o.bind(this)),this.sandbox.on("husky.auto-complete.addons-search.select",function(a){p.call(this,a)},this)},l=function(){this.sandbox.dom.on(this.$el,"change",function(a){q.call(this,a)}.bind(this),".change-price")},m=function(a){this.options.data&&this.options.data.attributes.status&&this.options.data.attributes.status.id===a.id||(this.status=a,this.options.data.attributes.status=this.status,t.call(this,!1))},n=function(){t.call(this,!0),this.options.data.attributes.status=this.status},o=function(a){var b=a>0?"enable":"disable";this.sandbox.emit("husky.toolbar."+i.toolbarInstanceName+".item."+b,"deleteSelected",!1)},p=function(a){this.sandbox.dom.empty(this.$find(i.priceListElementId)),r.call(this,i.priceListElementId);var a=$.getJSON("api/products/"+a.id+"?locale="+this.options.locale);a.done(function(a){z.call(this,a,null)}.bind(this))},q=function(a){var b=$(a.currentTarget),c=b.is(":checked"),d=this.sandbox.dom.find("#addon-price-"+b.data("currency"));d.prop("disabled",!c)},r=function(a){var b=this.sandbox.dom.createElement('<div class="'+i.loaderClass+'"/>'),c=this.sandbox.dom.find(a);this.sandbox.dom.append(c,b),this.sandbox.start([{name:"loader@husky",options:{el:b,size:"60px",color:"#ccc"}}])},s=function(){this.sandbox.dom.remove("."+i.loaderClass)},t=function(a){a!==this.productSaved&&(a?this.sandbox.emit("sulu.header.toolbar.item.disable","save",!0):this.sandbox.emit("sulu.header.toolbar.item.enable","save",!1)),this.productSaved=a},u=function(){if(!this.currenciesRequest){var a="api/currencies?flat=true&locale="+this.options.locale;this.currenciesRequest=$.getJSON(a,function(a){f=a._embedded.currencies}.bind(this))}return this.currenciesRequest},v=function(){this.options.data.attributes.status=this.status,this.sandbox.emit("sulu.products.save",this.options.data.attributes,!0),this.saved=!1},w=function(){var a,c="post";if(null!==g){null!==h?(a=b.findOrCreate({id:h.id}),c="put"):a=new b,a.set({addon:g.id});var d=[];u.call(this).done(function(){this.sandbox.util.foreach(f,function(a){var b=this.sandbox.dom.find("#change-price-"+a.code,this.$el);if(b[0]&&b[0].checked){var c={};c.currency=a.code;var e=this.sandbox.parseFloat(this.sandbox.dom.val("#addon-price-"+a.code));isNaN(e)||(c.value=e,d.push(c))}}.bind(this))}.bind(this)),a.set({prices:d}),a.saveToProduct(this.options.data.id,{type:c,success:function(){this.sandbox.emit("husky.datagrid."+i.datagridInstanceName+".update"),this.sandbox.emit("sulu.header.toolbar.item.disable","save",!0)}.bind(this),error:function(){this.sandbox.emit("sulu.labels.error.show","product.product-addons.save-error")}.bind(this)})}},x=function(){this.sandbox.emit("husky.datagrid."+i.datagridInstanceName+".items.get-selected",function(a){y.call(this,a)}.bind(this))},y=function(a){this.sandbox.util.foreach(a,function(a){var b=$.ajax("api/addons/"+a,{method:"delete"});b.done(function(){this.sandbox.emit("husky.datagrid."+i.datagridInstanceName+".record.remove",a),this.sandbox.emit("sulu.header.toolbar.item.disable","save",!0)}.bind(this)),b.fail(function(){this.sandbox.emit("sulu.labels.error.show","product.product-addons.remove-error")}.bind(this))}.bind(this))},z=function(a,b){g=a,h=b,u.call(this).done(function(){var c,e=[],g=null,h={},j={};this.sandbox.util.foreach(a.prices,function(a){h[a.currency.code]=a.price}.bind(this)),null!==b&&this.sandbox.util.foreach(b.prices,function(a){j[a.currency.code]=a.price}.bind(this)),this.sandbox.util.foreach(f,function(a){g={},g.id=a.id,g.defaultPrice=this.sandbox.numberFormat(0,"n"),h[a.code]&&(g.defaultPrice=this.sandbox.numberFormat(h[a.code],"n")),g.price=g.defaultPrice,j[a.code]&&(g.price=this.sandbox.numberFormat(j[a.code],"n")),g.currencyCode=a.code,g.overwritten=g.defaultPrice==g.price?!1:!0,e.push(g),g=null}.bind(this)),c=this.$find(i.priceListElementId),s.call(this),this.sandbox.util.foreach(e,function(a){a.translate=this.sandbox.translate;var b=this.sandbox.util.template(d,a);this.sandbox.dom.append(c,b)}.bind(this))}.bind(this))},A=function(b){var c=a.get("suluproduct.components.autocomplete.default");c.instanceName="addons-search",c.el="#addons-search-field",c.remoteUrl=j(),c.noNewValues=!0,c.fields=[{id:"number",width:"60px"},{id:"name"}],null!==b&&(c.value=b.addon),this.sandbox.start([{name:"auto-complete@husky",options:c}])},B=function(a){var b=this.sandbox.dom.createElement(this.sandbox.util.template(c,{translate:this.sandbox.translate})),d=this.sandbox.dom.createElement("<div>");this.sandbox.dom.append(this.$el,d),this.sandbox.start([{name:"overlay@husky",options:{el:d,supportKeyInput:!1,title:this.sandbox.translate(a),skin:"wide",openOnStart:!0,removeOnClose:!0,instanceName:i.overlayInstanceName,data:b,okCallback:w.bind(this)}}])},C=function(){B.call(this,"product.product-addons.add"),A.call(this,null)},D=function(a){B.call(this,"product.product-addons.edit"),this.sandbox.once("husky.overlay.product-addon-overlay.opened",function(){r.call(this,i.priceListElementId)}.bind(this));var b=$.getJSON("api/addons/"+a+"?locale="+this.options.locale);b.done(function(a){A.call(this,a),this.sandbox.once("husky.auto-complete.addons-search.initialized",function(){this.sandbox.dom.attr(this.$find("#addons-search"),"disabled","disabled")}.bind(this)),z.call(this,a.addon,a)}.bind(this))},E=function(){this.sandbox.sulu.initListToolbarAndList.call(this,"addons","api/addon/fields",{el:"#product-addons-toolbar",instanceName:i.toolbarInstanceName,hasSearch:!1,template:this.sandbox.sulu.buttons.get({add:{options:{callback:C.bind(this)}},deleteSelected:{options:{callback:x.bind(this)}}})},{el:"#product-addons-list",url:"api/products/"+this.options.data.id+"/addons?flat=true",instanceName:i.datagridInstanceName,resultKey:"addons",actionCallback:D.bind(this),viewOptions:{table:{selectItem:{type:"checkbox"}}}})},F=function(){this.sandbox.start("#product-addons-form"),E.call(this)};return{name:"Sulu Product Addons View",templates:["/admin/product/template/product/addons"],render:function(){this.sandbox.dom.html(this.$el,this.renderTemplate(this.templates[0])),F.call(this)},initialize:function(){k.call(this),l.call(this),this.status=this.options.data.attributes.status,this.sandbox.emit("product.state.change",this.status),this.render(),this.sandbox.emit("sulu.header.toolbar.item.disable","save",!1)}}});