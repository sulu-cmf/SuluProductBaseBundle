define(["config","text!suluproduct/components/products/components/edit/attributes/overlay-content.html","services/product-type-manager","suluproduct/collections/attributes","suluproduct/models/variantAttribute"],function(a,b,c,d,e){"use strict";var f=null,g=null,h={ADD:1,DELETE:2,UPDATE:3},i={typeText:"product.attribute.type.text",datagridInstanceName:"product-attribute-datagrid",variantAttributesDatagridInstanceName:"variant-attribute-datagrid",attributesToolbarInstanceName:"product-attribute-list-toolbar",variantAttributesToolbarInstanceName:"variant-attribute-list-toolbar",overlayInstanceName:"product-attribute-overlay",selectInstanceName:"product-attribute-select"},j={variantAttributesContainer:"#js-variant-attributes-container"},k=function(){var a=$.Deferred(),b=new d({locale:this.options.locale});return b.fetch({success:function(b){var c=[];this.attributes=[],$.each(b.toJSON(),function(a,b){var d={id:b.id,name:b.name};this.attributes[b.id]=b,b.type.name===i.typeText&&c.push(d)}.bind(this)),a.resolve(c)}.bind(this),error:function(){console.error("Error retrieving attributes from server"),a.fail()}}),a.promise()},l=function(){this.sandbox.on("product.state.change",p.bind(this)),this.sandbox.on("sulu.toolbar.save",o.bind(this)),this.sandbox.on("sulu.products.saved",n.bind(this)),this.sandbox.on("husky.datagrid."+i.datagridInstanceName+".number.selections",m.bind(this,i.attributesToolbarInstanceName)),this.sandbox.on("husky.datagrid."+i.variantAttributesDatagridInstanceName+".number.selections",m.bind(this,i.variantAttributesToolbarInstanceName))},m=function(a,b){var c=b>0?"enable":"disable";this.sandbox.emit("husky.toolbar."+a+".item."+c,"delete",!1)},n=function(a){var b=a.attributes;if(a.action===h.ADD){var c=_.findWhere(b,{attributeId:a.attributeIdAdded});this.sandbox.emit("husky.datagrid."+i.datagridInstanceName+".record.add",c)}else a.action===h.DELETE?$.each(a.attributeIdsDeleted,function(a,b){this.sandbox.emit("husky.datagrid."+i.datagridInstanceName+".record.remove",b)}.bind(this)):a.action===h.UPDATE&&this.sandbox.emit("husky.datagrid."+i.datagridInstanceName+".records.set",b);q.call(this,!0),this.options.data.attributes.status=this.status},o=function(){this.sendData={},this.sendData.status=this.status,this.sendData.id=this.options.data.id,t.call(this)},p=function(a){this.options.data&&this.options.data.attributes.status&&this.options.data.attributes.status.id===a.id||(this.status=a,this.options.data.attributes.status=this.status,q.call(this,!1))},q=function(a){a!==this.saved&&(a?this.sandbox.emit("sulu.header.toolbar.item.disable","save",!0):this.sandbox.emit("sulu.header.toolbar.item.enable","save",!1)),this.saved=a},r=function(a){f=null;var c=this.sandbox.dom.createElement(this.sandbox.util.template(b,{translate:this.sandbox.translate,shouldHideValueField:a}));return this.sandbox.dom.append(this.$el,c),c},s=function(){k.call(this).done(function(a){H.call(this,r.call(this,!1),u.bind(this)),I.call(this,a)}.bind(this))},t=function(){this.saved=!1,this.sandbox.emit("sulu.products.save",this.sendData)},u=function(){if(f){this.sendData={};var a=this.sandbox.dom.val("#attribute-name"),b=this.options.data.attributes.attributes,c=_.findWhere(b,{attributeId:f});if(c)c.attributeValueName=a,c.attributeValueLocale=this.options.locale,this.sendData.action=h.UPDATE;else{var d={attributeId:f,attributeValueName:a,attributeValueLocale:this.options.locale};b.push(d),this.sendData.action=h.ADD}this.sendData.attributeIdAdded=f,this.sendData.attributes=b,this.sendData.status=this.status,this.sendData.id=this.options.data.attributes.id,t.call(this)}},v=function(){if(f&&g){var a=new e({productId:this.options.data.id,attributeId:f});a.save({},{success:x.bind(this),error:z.bind(this)})}},w=function(){var a=[];this.sandbox.emit("husky.datagrid."+i.variantAttributesDatagridInstanceName+".items.get-selected",function(b){a=b});var b=a.length;if(!(1>b)){var c=0;this.sandbox.util.foreach(a,function(a){var d=new e({productId:this.options.data.id,id:a});d.destroy({success:function(){c++,A.call(this,a),B.call(this,c,b)}.bind(this),error:C.bind(this)})}.bind(this))}},x=function(){this.options.data.attributes.variantAttributes.push(this.attributes[f]),this.sandbox.emit("sulu.labels.success.show","labels.success.save-desc","labels.success"),this.sandbox.emit("husky.datagrid."+i.variantAttributesDatagridInstanceName+".record.add",{id:f,name:g})},y=function(a){var b=this.options.data.attributes.variantAttributes;this.options.data.attributes.variantAttributes=$.grep(b,function(b){return b.id!=a})},z=function(){this.sandbox.emit("sulu.labels.error.show","sulu_product.labels.save-error","labels.error")},A=function(a){y.call(this,a),this.sandbox.emit("husky.datagrid."+i.variantAttributesDatagridInstanceName+".record.remove",a)},B=function(a,b){a===b&&this.sandbox.emit("sulu.labels.success.show","labels.success.delete-desc","labels.success")},C=function(){this.sandbox.emit("sulu.labels.error.show","sulu_product.labels.delete-error","labels.error")},D=function(){this.sandbox.emit("husky.datagrid."+i.datagridInstanceName+".items.get-selected",function(a){var b=this.options.data.attributes.attributes;this.sendData={};var c=[];_.each(a,function(a){var d=_.findWhere(b,{attributeId:a});b=_.without(b,d),c.push(a)}),this.sendData.attributeIdsDeleted=c,this.sendData.attributes=b,this.sendData.status=this.status,this.sendData.id=this.options.data.id,this.sendData.action=h.DELETE,t.call(this)}.bind(this))},E=function(a,b,c){return a.attributeLocale&&a.attributeLocale==a.fallbackLocale&&a.attributeLocale!=c?(b.title=a.attributeLocale,b):!1},F=function(a,b,c){return a.attributeValueLocale&&a.attributeValueLocale==a.fallbackLocale&&a.attributeValueLocale!=c?(b.title=a.attributeValueLocale,b):!1},G=function(){var a={el:"#product-attribute-list",instanceName:i.datagridInstanceName,idKey:"attributeId",resultKey:"attributes",matchings:[{name:"attributeName",content:this.sandbox.translate("product.attribute.name")},{name:"attributeValueName",content:this.sandbox.translate("product.attribute.value")}],viewOptions:{table:{type:"checkbox",badges:[{column:"attributeName",callback:function(a,b){return E(a,b,this.options.locale)}.bind(this)},{column:"attributeValueName",callback:function(a,b){return F(a,b,this.options.locale)}.bind(this)}]}},data:this.options.data.attributes};this.sandbox.start([{name:"datagrid@husky",options:a},{name:"toolbar@husky",options:{el:"#product-attribute-toolbar",instanceName:i.attributesToolbarInstanceName,small:!1,buttons:[{id:"add",icon:"plus-circle",callback:s.bind(this)},{id:"delete",icon:"trash-o",disabled:!0,callback:D.bind(this)}]}}])},H=function(a,b){var c=this.sandbox.dom.createElement("<div>");this.sandbox.dom.append(this.$el,c),this.sandbox.start([{name:"overlay@husky",options:{el:c,supportKeyInput:!1,title:this.sandbox.translate("product.attribute.overlay.title"),skin:"normal",openOnStart:!0,removeOnClose:!0,instanceName:i.overlayInstanceName,data:a,okCallback:b}}])},I=function(a){var b=[],c=this.sandbox.translate("product.attribute.overlay.defaultlabel");a.length>0&&"object"==typeof a[0]&&"string"==typeof a[0].name?(f=a[0].id,b.push(a[0].name)):c=this.sandbox.translate("sulu_product.attribute.overlay.no-attributes");var d={el:"#selectBox",instanceName:i.selectInstanceName,multipleSelect:!1,defaultLabel:c,preSelectedElements:b,valueName:"name",isNative:!0,data:a};this.sandbox.start([{name:"select@husky",options:d}]),this.sandbox.on("husky.select."+i.selectInstanceName+".selected.item",function(a,b){f=parseInt(a),g=b})},J=function(){k.call(this).done(function(a){var b=[];this.sandbox.emit("husky.datagrid."+i.variantAttributesDatagridInstanceName+".records.get",function(a){b=a.map(function(a){return a.id})}.bind(this));var c=[];this.sandbox.util.foreach(a,function(a){-1===b.indexOf(a.id)&&c.push(a)}),H.call(this,r.call(this,!0),v.bind(this)),I.call(this,c)}.bind(this))},K=function(){var a={el:"#js-variant-attribute-list",instanceName:i.variantAttributesDatagridInstanceName,resultKey:"variantAttributes",matchings:"/admin/api/product-variant-attributes/fields?locale="+this.options.locale,url:"/admin/api/products/"+this.options.data.id+"/variant-attributes?locale="+this.options.locale};this.sandbox.start([{name:"datagrid@husky",options:a}]),0===this.options.data.attributes.numberOfVariants&&this.sandbox.start([{name:"toolbar@husky",options:{el:"#js-variant-attribute-toolbar",instanceName:i.variantAttributesToolbarInstanceName,small:!1,buttons:[{id:"add",icon:"plus-circle",callback:J.bind(this)},{id:"delete",icon:"trash-o",disabled:!0,callback:w.bind(this)}]}}])},L=function(){var a=this.options.data.attributes.type.id;a===c.types.PRODUCT_WITH_VARIANTS&&($(j.variantAttributesContainer).removeClass("is-hidden"),K.call(this))},M=function(){G.call(this)};return{name:"Sulu Product Attributes View",templates:["/admin/product/template/product/attributes"],initialize:function(){this.attributes=[],l.call(this),this.status=this.options.data.attributes.status,this.sandbox.emit("product.state.change",this.status),this.render(),q.call(this,!0)},render:function(){this.sandbox.dom.html(this.$el,this.renderTemplate("/admin/product/template/product/attributes",{translate:this.sandbox.translate})),M.call(this),L.call(this)}}});